<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KJ Admin - KJ-Nomad | Nomad Karaoke</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="logo">KJ-NOMAD Admin</div>
        </div>
    </div>

    <div class="container">
        <div class="setup-wizard">
            <!-- Step 1: Session Created -->
            <div id="step-1" class="step active">
                <h2 class="step-title">Online Session Created!</h2>
                <p class="step-description">
                    Your KJ-Nomad session is ready. Share the session ID with singers and set up your player screens.
                </p>
                
                <div class="session-info">
                    <div class="session-id" id="session-id">Loading...</div>
                    <p>Session ID - Share this with singers</p>
                    <button class="copy-button" onclick="copySessionId()">Copy ID</button>
                </div>

                <div class="form-group">
                    <label class="form-label">KJ Name (Optional)</label>
                    <input type="text" class="form-input" id="kj-name" placeholder="Your name">
                </div>

                <div class="form-group">
                    <label class="form-label">Venue (Optional)</label>
                    <input type="text" class="form-input" id="venue" placeholder="Venue name">
                </div>

                <button class="button" onclick="nextStep()">Continue Setup</button>
            </div>

            <!-- Step 2: Local Server Setup -->
            <div id="step-2" class="step">
                <h2 class="step-title">Set Up Local Server</h2>
                <p class="step-description">
                    Download and run the KJ-Nomad server on your computer to handle video playback and library management.
                </p>

                <div class="instructions">
                    <div class="instructions-title">Setup Instructions:</div>
                    <ol>
                        <li>Download the KJ-Nomad server for your operating system</li>
                        <li>Run the executable and enter session ID: <strong id="session-id-2">1234</strong></li>
                        <li>Select your local media library (optional)</li>
                        <li>The server will automatically connect to this session</li>
                    </ol>
                </div>

                <div id="server-status" class="alert alert-error">
                    <span class="status-indicator status-disconnected">
                        ‚óè Local server not connected
                    </span>
                    <p>Waiting for local server connection...</p>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <a href="https://github.com/nomadkaraoke/kj-nomad/releases/latest/download/KJ-Nomad-1.0.0.dmg" class="button" style="text-decoration: none; display: inline-block; margin: 0.5rem;">
                        üì• Download for macOS (DMG)
                    </a>
                    <a href="https://github.com/nomadkaraoke/kj-nomad/releases/latest/download/KJ-Nomad-1.0.0-mac.zip" class="button secondary" style="text-decoration: none; display: inline-block; margin: 0.5rem;">
                        üì¶ Download for macOS (ZIP)
                    </a>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                        Downloads hosted on GitHub Releases
                    </p>
                </div>

                <button class="button" onclick="nextStep()" disabled id="continue-button">
                    Continue (Local Server Required)
                </button>
            </div>

            <!-- Step 3: Player Screens -->
            <div id="step-3" class="step">
                <h2 class="step-title">Set Up Player Screens</h2>
                <p class="step-description">
                    Connect your player screens (TVs, projectors, monitors) to display karaoke videos with perfect synchronization.
                </p>

                <div class="instructions">
                    <div class="instructions-title">Player Setup Instructions:</div>
                    <ol>
                        <li>Open a web browser on each player device</li>
                        <li>Navigate to: <strong>kj.nomadkaraoke.com/player</strong></li>
                        <li>Enter session ID: <strong id="session-id-3">1234</strong></li>
                        <li>Set browser to fullscreen mode (F11)</li>
                        <li>Repeat for each additional screen</li>
                    </ol>
                </div>

                <div id="devices-section">
                    <h3 style="margin-bottom: 1rem;">Connected Devices</h3>
                    <ul class="device-list" id="device-list">
                        <li class="device-item">
                            <div class="device-info">
                                <div class="device-name">No devices connected</div>
                                <div class="device-ip">Waiting for player connections...</div>
                            </div>
                            <span class="status-indicator status-pending">‚óè Pending</span>
                        </li>
                    </ul>
                </div>

                <button class="button" onclick="nextStep()">Start Hosting</button>
            </div>

            <!-- Step 4: Session Active -->
            <div id="step-4" class="step">
                <h2 class="step-title">Session Active!</h2>
                <p class="step-description">
                    Your KJ-Nomad session is now live. Singers can request songs, and you can manage everything from here.
                </p>

                <div class="session-info">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 1.5rem; color: var(--pink);">Session ID: <span id="session-id-4">1234</span></div>
                            <div style="color: var(--text-secondary);">Singer URL: sing.nomadkaraoke.com</div>
                        </div>
                        <span class="status-indicator status-connected">‚óè Live</span>
                    </div>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Full admin controls coming soon. For now, manage your queue using the local server interface.
                    </p>
                    <button class="button secondary" onclick="endSession()">End Session</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../assets/js/main.js"></script>
    <script>
        let currentStep = 1;
        let sessionId = null;
        let ws = null;

        // Get session ID from URL or create new session
        async function initializeSession() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session');
            
            if (!sessionId) {
                // Redirect back to landing page
                window.location.href = '/';
                return;
            }

            // Display session ID
            document.querySelectorAll('[id^="session-id"]').forEach(el => {
                el.textContent = sessionId;
            });

            // Try to connect WebSocket for real-time updates
            connectWebSocket();
        }

        function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.host;
                ws = new WebSocket(`${protocol}//${host}/sessions/${sessionId}/ws?type=admin`);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    // Try to reconnect after 3 seconds
                    setTimeout(connectWebSocket, 3000);
                };
            } catch (error) {
                console.error('WebSocket connection failed:', error);
            }
        }

        function handleWebSocketMessage(message) {
            console.log('Received message:', message);
            
            switch (message.type) {
                case 'client_connected':
                    if (message.payload.clientType === 'local-server') {
                        updateServerStatus(true);
                    } else if (message.payload.clientType === 'player') {
                        updatePlayerDevices();
                    }
                    break;
                case 'client_disconnected':
                    if (message.payload.clientType === 'local-server') {
                        updateServerStatus(false);
                    }
                    break;
            }
        }

        function updateServerStatus(connected) {
            const statusEl = document.getElementById('server-status');
            const continueBtn = document.getElementById('continue-button');
            
            if (connected) {
                statusEl.className = 'alert alert-success';
                statusEl.innerHTML = `
                    <span class="status-indicator status-connected">‚óè Local server connected</span>
                    <p>Server is ready to handle video playback and library management.</p>
                `;
                continueBtn.disabled = false;
                continueBtn.textContent = 'Continue to Player Setup';
            } else {
                statusEl.className = 'alert alert-error';
                statusEl.innerHTML = `
                    <span class="status-indicator status-disconnected">‚óè Local server not connected</span>
                    <p>Waiting for local server connection...</p>
                `;
                continueBtn.disabled = true;
                continueBtn.textContent = 'Continue (Local Server Required)';
            }
        }

        function updatePlayerDevices() {
            // TODO: Get actual device list from WebSocket
            // For now, just show placeholder
        }

        function nextStep() {
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep++;
            document.getElementById(`step-${currentStep}`).classList.add('active');
        }

        function copySessionId() {
            navigator.clipboard.writeText(sessionId).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        async function saveSessionInfo() {
            const kjName = document.getElementById('kj-name').value;
            const venue = document.getElementById('venue').value;
            
            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        kjName,
                        venue
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save session info');
                }
            } catch (error) {
                console.error('Failed to save session info:', error);
            }
        }

        async function endSession() {
            if (confirm('Are you sure you want to end this session?')) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        window.location.href = '/';
                    }
                } catch (error) {
                    console.error('Failed to end session:', error);
                    alert('Failed to end session. Please try again.');
                }
            }
        }

        // Initialize when page loads
        window.addEventListener('load', initializeSession);
    </script>
</body>
</html>
